#include <stdio.h>
#include <sys/mman.h>
#include <unistd.h>
#include <string.h>

/*
__asm__ ( 
			"movq $0xaabbccddaabbccdd, %rax\t\n"
			"movq $0xaabbccddaabbccdd, %rdi\t\n"
			"movq $0xaabbccddaabbccdd, %rsi\t\n"
			"movq $0xaabbccddaabbccdd, %rdx\t\n"
			"movq $0xaabbccddaabbccdd, %rcx\t\n"
			"movq $0xaabbccddaabbccdd, %r8\t\n"
			"movq $0xaabbccddaabbccdd, %r9\t\n"
			"movq $0xaabbccddaabbccdd, %rbx\t\n"
);
*/
unsigned char clobberContext[] = { 0x48, 0xB8, 0xDD, 0xCC, 0xBB, 0xAA, 0xDD, 0xCC, 0xBB, 0xAA, 0x48, 0xBF, 0xDD, 0xCC, 0xBB, 0xAA, 0xDD, 0xCC, 0xBB, 0xAA, 0x48, 0xBE, 0xDD, 0xCC, 0xBB, 0xAA, 0xDD, 0xCC, 0xBB, 0xAA, 0x48, 0xBA, 0xDD, 0xCC, 0xBB, 0xAA, 0xDD, 0xCC, 0xBB, 0xAA, 0x48, 0xB9, 0xDD, 0xCC, 0xBB, 0xAA, 0xDD, 0xCC, 0xBB, 0xAA, 0x49, 0xB8, 0xDD, 0xCC, 0xBB, 0xAA, 0xDD, 0xCC, 0xBB, 0xAA, 0x49, 0xB9, 0xDD, 0xCC, 0xBB, 0xAA, 0xDD, 0xCC, 0xBB, 0xAA, 0x48, 0xBB, 0xDD, 0xCC, 0xBB, 0xAA, 0xDD, 0xCC, 0xBB, 0xAA }; 

#define MAX_BYTES_READ 45

int main () 
{
		/* Map 2 pages of memory (0x2000 bytes) @ 0x1337000 with RWX permissions */
		void *code = mmap(	(void *)0x1337000, 0x2000, 
						PROT_READ|PROT_WRITE|PROT_EXEC, 
						MAP_PRIVATE|MAP_ANON, 0, 0);

		/* copy assembled instructions to clobber CPU state @ code */
		memcpy (code, clobberContext, sizeof(clobberContext));	

		/* read shellcode from STDIN and place it after clobber instructions */
        fprintf (stderr, "Reading %d bytes now...\n", MAX_BYTES_READ);
		size_t read_bytes = read(0, code+sizeof(clobberContext), MAX_BYTES_READ);

		fprintf (stderr, "\nShellcode (%ld) base @: %p\n", 
						read_bytes, code+sizeof(clobberContext));

		/* transfer code flow to shellcode */
		((void(*)())code)();
}
