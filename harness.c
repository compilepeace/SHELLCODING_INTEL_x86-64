#include <stdio.h>
#include <sys/mman.h>
#include <unistd.h>
#include <string.h>

/*
__asm__ ( 
			"movq $0xaabbccddaabbccdd, %rax\t\n"
			"movq $0xaabbccddaabbccdd, %rdi\t\n"
			"movq $0xaabbccddaabbccdd, %rsi\t\n"
			"movq $0xaabbccddaabbccdd, %rdx\t\n"
			"movq $0xaabbccddaabbccdd, %r10\t\n"
			"movq $0xaabbccddaabbccdd, %r8\t\n"
			"movq $0xaabbccddaabbccdd, %r9\t\n"
			"movq $0xaabbccddaabbccdd, %rbx\t\n"
			"movq $0xaabbccddaabbccdd, %rcx\t\n"
);
*/

// $ xxd -i ./clobber.raw
unsigned char clobberContext[] = {
  0x48, 0xb8, 0xdd, 0xcc, 0xbb, 0xaa, 0xdd, 0xcc, 0xbb, 0xaa, 0x48, 0xbf,
  0xdd, 0xcc, 0xbb, 0xaa, 0xdd, 0xcc, 0xbb, 0xaa, 0x48, 0xbe, 0xdd, 0xcc,
  0xbb, 0xaa, 0xdd, 0xcc, 0xbb, 0xaa, 0x48, 0xba, 0xdd, 0xcc, 0xbb, 0xaa,
  0xdd, 0xcc, 0xbb, 0xaa, 0x49, 0xba, 0xdd, 0xcc, 0xbb, 0xaa, 0xdd, 0xcc,
  0xbb, 0xaa, 0x49, 0xb8, 0xdd, 0xcc, 0xbb, 0xaa, 0xdd, 0xcc, 0xbb, 0xaa,
  0x49, 0xb9, 0xdd, 0xcc, 0xbb, 0xaa, 0xdd, 0xcc, 0xbb, 0xaa, 0x48, 0xbb,
  0xdd, 0xcc, 0xbb, 0xaa, 0xdd, 0xcc, 0xbb, 0xaa, 0x48, 0xb9, 0xdd, 0xcc,
  0xbb, 0xaa, 0xdd, 0xcc, 0xbb, 0xaa
};

int main (int argc, char **argv) 
{
	fprintf (stderr, "Usage: %s < <pic.bin>\n\n", argv[0]);

	/* Map 2 pages of memory (0x2000 bytes) @ 0x1337000 with RWX permissions */
	void *code = mmap(	(void *)0x1337000, 0x2000, 
					PROT_READ|PROT_WRITE|PROT_EXEC, 
					MAP_PRIVATE|MAP_ANON, 0, 0);

	/* copy assembled instructions to clobber CPU state @ code */
	memcpy (code, clobberContext, sizeof(clobberContext));	

	/* read shellcode from STDIN and place it after clobber instructions */
	size_t read_bytes = read(0, code+sizeof(clobberContext), 0x1000);

	fprintf (stderr, "Shellcode (%ld) base @: %p\n", 
					read_bytes, code+sizeof(clobberContext));

	/* transfer code flow to shellcode */
	((void(*)())code)();
}
